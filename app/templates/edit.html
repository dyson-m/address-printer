{% extends "base.html" %}

{% block content %}
    <form action="" method="POST" novalidate id="edit-form">
        {{ form.hidden_tag() }}

        {# hidden field used to force-save invalid address on second click #}
        <input type="hidden" name="force_save" id="force_save" value="0">

        {# flags for JS #}
        <div id="flags"
             data-address-valid="{{ '1' if address_is_valid else '0' }}"
             data-show-success="{{ '1' if show_success else '0' }}"
            data-need-confirm="{{ '1' if need_confirm else '0' }}">
        </div>

        <h2>{{ form.line0(class="larger") }} ⬅ Name</h2>
        <h2>{{ form.line1(class="larger") }} ⬅ Address & Street</h2>
        <h2>{{ form.line2(class="larger") }} ⬅ City, State & Zipcode</h2>

        <h2>
            {{ form.submit(class_="btn", id="save-button") }}
            {{ form.cancel(class_="btn btn-gray", id="cancel-button") }}
            {% if show_delete %}
                {{ form.delete(class_="btn btn-red", id="delete-button") }}
            {% endif %}
        </h2>
    </form>
    {# Simple toast element #}
    <div id="toast" class="toast">Placeholder</div>
    <script>
        function showToast(msg, durationMs = 2500) {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.classList.add("show");

            if (durationMs !== null) {
                setTimeout(() => {
                    toast.classList.remove("show");
                }, durationMs);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("edit-form");
            const flags = document.getElementById("flags");
            const forceField = document.getElementById("force_save");

            const line0Input = document.getElementById("line0");
            const line1Input = document.getElementById("line1");
            const line2Input = document.getElementById("line2");

            const isAddressValid = flags.dataset.addressValid === "1";
            const showSuccess = flags.dataset.showSuccess === "1";
            const needConfirm = flags.dataset.needConfirm === "1";

            const saveButtonId = "save-button";
            const deleteButtonId = "delete-button";

            // 1) Success → toast, then redirect in 4 seconds 
            if (showSuccess) {

                // Disable all action buttons immediately
                const saveBtn   = document.getElementById("save-button");
                const cancelBtn = document.getElementById("cancel-button");
                const deleteBtn = document.getElementById("delete-button");

                if (saveBtn)   saveBtn.disabled   = true;
                if (cancelBtn) cancelBtn.disabled = true;
                if (deleteBtn) deleteBtn.disabled = true;

                // Visually fade-out / gray them
                [saveBtn, cancelBtn, deleteBtn].forEach(btn => {
                    if (btn) {
                        btn.style.opacity = "0.5";
                        btn.style.pointerEvents = "none";
                    }
                });

                // Show the banner toast
                showToast("Address updated!", 4000);

                // Redirect after timeout
                setTimeout(() => {
                    window.location.href = "/";
                }, 4000);
            }

            // 2) Invalid from server → show toast immediately, and mark this page as "confirmed if you submit again"
            if (needConfirm && !isAddressValid) {
                showToast("Invalid Address. Are you sure? Press save again to confirm.", 8000);
                forceField.value = "1";  // next submit will be treated as forced

                // Timeout window: if Save not pressed within X seconds, invalidate confirmation
                setTimeout(() => {
                    forceField.value = "0";
                    //showToast("Confirmation timed out. Press Save again.", 3000);
                }, 8000);
            }

            // State for delete confirmation
            let deleteConfirmActive = false;
            let deleteConfirmTimer = null;

            form.addEventListener("submit", function (e) {
                const submitter = e.submitter;  // which button was pressed

                if (!submitter) {
                    return;  // failsafe
                }

                // Cancel: let the form submit
                if (submitter.id === "cancel-button") {
                    return;
                }

                // Submit: All 3 fields must not be blank
                if (submitter.id === "save-button") {
                    const v0 = line0Input.value.trim();
                    const v1 = line1Input.value.trim();
                    const v2 = line2Input.value.trim();

                    if (!v0 || !v1 || !v2) {
                        e.preventDefault();
                        showToast("Please fill in all 3 lines before saving.", 4000);
                        return;  
                    }
                }

                // Delete: require second click within 3 seconds
                if (submitter.id === deleteButtonId) {
                    if (!deleteConfirmActive) {
                        e.preventDefault();  // block first submit

                        deleteConfirmActive = true;
                        showToast("DELETE ADDRESS? ARE YOU SURE? Press again to permanently delete address.", 3000);

                        deleteConfirmTimer = setTimeout(() => {
                            deleteConfirmActive = false;
                        }, 3000);

                    } else {
                        // Second click within 3 seconds: allow form to submit normally
                        clearTimeout(deleteConfirmTimer);
                        deleteConfirmActive = false;
                    }

                    return; 
                }
            });
        });
    </script>
{% endblock %}